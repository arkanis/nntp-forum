<VirtualHost *:80>
	# The unencrypted virtual host only redirects to the HTTPS host
	ServerName	news2.mi.hdm-stuttgart.de
	Redirect	permanent	/	https://news2.mi.hdm-stuttgart.de/
	
	LogLevel	warn
	ErrorLog	/var/www/nntp-forum/logs/redirector-error.log
	CustomLog	/var/www/nntp-forum/logs/redirector-access.log combined
</VirtualHost>

# Certificates for the entire Apache server. SSL does not work with name based virtual hosts.
SSLCertificateFile	/etc/ssl/certs/news.hdm-stuttgart.de.pem
SSLCertificateKeyFile	/etc/ssl/private/news.hdm-stuttgart.de.key

<VirtualHost *:443>
	ServerName	news2.mi.hdm-stuttgart.de
	DocumentRoot	/var/www/nntp-forum/public
	SSLEngine	on

	LogLevel	warn
	ErrorLog	/var/www/nntp-forum/logs/site-error.log
	CustomLog	/var/www/nntp-forum/logs/site-access.log combined
	
	# Show nice error pages that uses the same layout as the PHP pages
	ErrorDocument	401	/app/errors/unauthorized.php
	ErrorDocument	403	/app/errors/forbidden.php
	ErrorDocument	404	/app/errors/not_found.php
	
	# Disable PHP magic quotes, we do the magic by ourselfs…
	php_flag	magic_quotes_gpc	Off
	php_flag	display_errors	On
	
	RewriteEngine	on
	
	# Intercept typical files that browsers asked for to stop the server to
	# look for newsgroups with that name
	# 	/favicon.ico
	RewriteRule	/favicon.ico	-	[gone,last]
	# 	/robots.txt
	RewriteRule	/robots.txt	-	[gone,last]
	
	# Newsfeeds:
	# 	GET /offiziell.xml	→	/app/newsfeed.php?id=offiziell
	RewriteRule	^/([^\./]+).xml$	/app/newsfeed.php?name=$1	[last,qsappend]
	
	# Newsgroups:
	#	GET /	→	/app/newsgroups.php
	RewriteCond	%{REQUEST_METHOD}	GET|HEAD
	RewriteRule	^/$	/app/newsgroups.php	[last,qsappend]
	
	# Topics:
	#	GET /hdm.mi.allgemein	→	/app/topics.php?newsgroup=hdm.mi.allgemein
	RewriteCond	%{REQUEST_METHOD}	GET|HEAD
	RewriteRule	^/([^/]+)$	/app/topics.php?newsgroup=$1	[last,qsappend]
	# 	POST /hdm.mi.allgemein	→	/app/message_create.php?newsgroup=hdm.mi.allgemein
	RewriteCond	%{REQUEST_METHOD}	POST
	RewriteRule	^/([^/]+)$	/app/messages/create.php?newsgroup=$1	[last,qsappend]
	
	# Messages:
	# 	GET /hdm.mi.allgemein/1820	→	/app/messages/index.php?newsgroup=hdm.mi.allgemein&number=1820
	RewriteCond	%{REQUEST_METHOD}	GET|HEAD
	RewriteRule	^/([^/]+)/(\d+)$	/app/messages/index.php?newsgroup=$1&number=$2	[last,qsappend]
	# 	POST /hdm.mi.allgemein/1820	→	/app/messages/create.php?newsgroup=hdm.mi.allgemein&number=1820
	RewriteCond	%{REQUEST_METHOD}	POST
	RewriteRule	^/([^/]+)/(\d+)$	/app/messages/create.php?newsgroup=$1&number=$2	[last,qsappend]
	# 	DELETE /hdm.mi.allgemein/1820	→	/app/messages/destroy.php?newsgroup=hdm.mi.allgemein&number=1820
	RewriteCond	%{REQUEST_METHOD}	DELETE
	RewriteRule	^/([^/]+)/(\d+)$	/app/messages/destroy.php?newsgroup=$1&number=$2	[last,qsappend]
	
	# Attachments:
	#	GET /hdm.mi.allgemein/1821/image.svg	→	/app/attachment.php?newsgroup=hdm.mi.allgemein&number=1820&attachment=image.svg
	RewriteCond	%{REQUEST_METHOD}	GET|HEAD
	RewriteRule	^/([^/]+)/(\d+)/([^/]+)$	/app/attachment.php?newsgroup=$1&number=$2&attachment=$3	[last,qsappend]
	
	<Directory /var/www/nntp-forum/public>
		# Accept either host authentication or HTTP authentication and
		# set host authentication to deny by default (it's only used to
		# clear access to show actions later on without a login).
		Satisfy	Any
		Order	Allow,Deny
		Deny from all
		
		# Protect all application actions with a login by default
		AuthType	Basic
		AuthName	"Bitte melde dich mit deinem HdM-Account an um die Newsgroups zu lesen."
		AuthBasicProvider	ldap
		AuthLDAPURL	ldap://ldap1.mi.hdm-stuttgart.de:389/ou=userlist,dc=hdm-stuttgart,dc=de?uid?sub?(objectClass=*)
		Require	valid-user
	</Directory>
	
	# Open up files necessary for the "login required" error page
	<Location /app/unauthorized.php>
		Allow from all
	</Location>
	<Location /styles/*>
		Allow from all
	</Location>
</VirtualHost>
